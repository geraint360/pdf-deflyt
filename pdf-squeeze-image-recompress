#!/usr/bin/env python3
"""
pdf-squeeze-image-recompress
Helper script for pdf-squeeze to handle ICC profile images using ImageMagick

DEPENDENCIES:
  System: ImageMagick (brew install imagemagick)
  Python: PyMuPDF (auto-installed in local venv on first run)

The script automatically creates a local virtual environment (.pdf-squeeze-venv)
and installs PyMuPDF on first run. No manual pip installation required.

USAGE:
  pdf-squeeze-image-recompress [-v] [-q QUALITY] INPUT OUTPUT
  
This script is normally called by pdf-squeeze automatically when needed.
"""

import sys
import os
import subprocess
import tempfile
import shutil
from pathlib import Path

def check_imagemagick():
    """Check if ImageMagick is available (magick or convert)"""
    return shutil.which('magick') is not None or shutil.which('convert') is not None

# Virtual environment setup for PyMuPDF only
SCRIPT_DIR = Path(__file__).parent.resolve()
VENV_DIR = SCRIPT_DIR / ".pdf-squeeze-venv"
VENV_PYTHON = VENV_DIR / "bin" / "python3"

def setup_venv():
    """Create virtual environment and install PyMuPDF only"""
    if VENV_DIR.exists():
        return True
    
    print("First run: Setting up Python environment...", file=sys.stderr)
    try:
        subprocess.run([sys.executable, "-m", "venv", str(VENV_DIR)], check=True)
        print("Installing PyMuPDF...", file=sys.stderr)
        subprocess.run([
            str(VENV_PYTHON), "-m", "pip", "install", "--quiet", "PyMuPDF"
        ], check=True)
        print("Setup complete!", file=sys.stderr)
        return True
    except subprocess.CalledProcessError as e:
        print(f"ERROR: Failed to setup environment: {e}", file=sys.stderr)
        return False

def run_in_venv():
    """Re-run this script in the virtual environment"""
    if not VENV_PYTHON.exists():
        if not setup_venv():
            sys.exit(1)
    os.execv(str(VENV_PYTHON), [str(VENV_PYTHON), __file__] + sys.argv[1:])

# If not running in venv, switch to it
if sys.prefix == sys.base_prefix:
    run_in_venv()

# Now in venv, import PyMuPDF
import fitz
import argparse

def convert_image_with_imagemagick(input_bytes, quality=75):
    """Convert image to JPEG using ImageMagick (preserves ICC)"""
    with tempfile.NamedTemporaryFile(suffix='.png', delete=False) as tmp_in:
        tmp_in.write(input_bytes)
        tmp_in_path = tmp_in.name
    
    tmp_out_path = tmp_in_path.replace('.png', '.jpg')
    
    try:
        # Try different ImageMagick command variants
        commands = [
            ['magick', tmp_in_path, '-quality', str(quality), tmp_out_path],  # IM7 Linux style
            ['magick', 'convert', tmp_in_path, '-quality', str(quality), tmp_out_path],  # IM7 macOS style
            ['convert', tmp_in_path, '-quality', str(quality), tmp_out_path]  # IM6 style
        ]
        
        for cmd in commands:
            if not shutil.which(cmd[0]):
                continue
                
            result = subprocess.run(cmd, capture_output=True, timeout=30)
            
            if result.returncode == 0 and os.path.exists(tmp_out_path):
                with open(tmp_out_path, 'rb') as f:
                    jpeg_bytes = f.read()
                return jpeg_bytes
        
        return None
        
    finally:
        try:
            os.unlink(tmp_in_path)
            if os.path.exists(tmp_out_path):
                os.unlink(tmp_out_path)
        except:
            pass

def recompress_pdf_images(input_path, output_path, quality=75, verbose=False):
    """Recompress images using ImageMagick for ICC safety"""
    
    if not check_imagemagick():
        print("ERROR: ImageMagick not found. Install with: brew install imagemagick", file=sys.stderr)
        return 1
    
    try:
        doc = fitz.open(input_path)
        
        if verbose:
            print(f"Processing {len(doc)} pages...", file=sys.stderr)
        
        for page_num in range(len(doc)):
            page = doc[page_num]
            image_list = page.get_images(full=True)
            
            if verbose and image_list:
                print(f"  Page {page_num + 1}: {len(image_list)} images", file=sys.stderr)
            
            for img_index, img in enumerate(image_list):
                xref = img[0]
                
                try:
                    # Extract image
                    base_image = doc.extract_image(xref)
                    image_bytes = base_image["image"]
                    image_ext = base_image["ext"]
                    width = base_image["width"]
                    height = base_image["height"]
                    
                    # Skip if already JPEG
                    if image_ext in ("jpeg", "jpg"):
                        if verbose:
                            print(f"    Image {img_index + 1}: already JPEG, skipping", file=sys.stderr)
                        continue
                    
                    if verbose:
                        print(f"    Image {img_index + 1}: converting {image_ext} to JPEG with ImageMagick", file=sys.stderr)
                    
                    # Convert using ImageMagick
                    new_image_bytes = convert_image_with_imagemagick(image_bytes, quality)
                    
                    if new_image_bytes is None:
                        if verbose:
                            print(f"      WARNING: ImageMagick conversion failed, skipping", file=sys.stderr)
                        continue
                    
                    # Only update if smaller
                    if len(new_image_bytes) >= len(image_bytes):
                        if verbose:
                            print(f"      Kept original (would be larger)", file=sys.stderr)
                        continue
                    
                    # Get the image rectangle (where it's placed on the page)
                    img_rects = page.get_image_rects(xref)
                    
                    if not img_rects:
                        if verbose:
                            print(f"      WARNING: Could not find image position, skipping", file=sys.stderr)
                        continue
                    
                    # Delete the old image
                    page.delete_image(xref)
                    
                    # Insert the new JPEG at each location where the old image was
                    for rect in img_rects:
                        page.insert_image(rect, stream=new_image_bytes, keep_proportion=True)
                    
                    if verbose:
                        reduction = (1 - len(new_image_bytes)/len(image_bytes)) * 100
                        print(f"      Compressed: {len(image_bytes)} â†’ {len(new_image_bytes)} bytes ({reduction:.1f}% smaller)", file=sys.stderr)
                    
                except Exception as e:
                    if verbose:
                        print(f"    WARNING: Failed to process image {img_index + 1}: {e}", file=sys.stderr)
                    continue
                    
        # Save
        doc.save(output_path, garbage=4, deflate=True, clean=True)
        doc.close()
        
        if verbose:
            print(f"Saved to: {output_path}", file=sys.stderr)
        
        return 0
        
    except Exception as e:
        print(f"ERROR: Failed to process PDF: {e}", file=sys.stderr)
        return 1

def main():
    parser = argparse.ArgumentParser(description='Recompress PDF images using ImageMagick')
    parser.add_argument('input', help='Input PDF file')
    parser.add_argument('output', help='Output PDF file')
    parser.add_argument('-q', '--quality', type=int, default=75, help='JPEG quality (1-100, default: 75)')
    parser.add_argument('-v', '--verbose', action='store_true', help='Verbose output')
    
    args = parser.parse_args()
    
    if not Path(args.input).exists():
        print(f"ERROR: Input file not found: {args.input}", file=sys.stderr)
        return 1
    
    return recompress_pdf_images(args.input, args.output, args.quality, args.verbose)

if __name__ == '__main__':
    sys.exit(main())