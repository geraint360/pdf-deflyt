name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: {}   # manual trigger also available

jobs:
  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (macOS)
        id: install-macos
        run: |
          brew update
          brew install ghostscript pdfcpu qpdf mupdf-tools exiftool poppler coreutils parallel imagemagick zsh
          pdfcpu version

      - name: Install linters (macOS)
        run: |
          set -euxo pipefail
          brew install shellcheck shfmt || true

      - name: Lint
        run: make lint

      - name: Smoke
        if: steps.install-macos.outcome == 'success'
        run: make smoke

      - name: Make script executable
        run: chmod +x pdf-deflyt

      - name: Run tests
        env:
          PDF_DEFLYT_TEST_JOBS: "4"
        run: make test

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-macos
          path: tests/build/logs

  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Linux)
        id: install-linux
        env:
          PDFCPU_VER: v0.7.1
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y ghostscript qpdf mupdf-tools poppler-utils exiftool parallel imagemagick curl golang-go zsh
          # Install pdfcpu via go install to avoid fragile archive downloads
          export GOBIN=/usr/local/bin
          go install github.com/pdfcpu/pdfcpu/cmd/pdfcpu@latest
          pdfcpu version

      - name: Make script executable
        run: chmod +x pdf-deflyt

      - name: Install linters (Linux)
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y shellcheck
          # shfmt (golang based)
          curl -sSLo /usr/local/bin/shfmt https://github.com/mvdan/sh/releases/download/v3.8.0/shfmt_v3.8.0_linux_amd64
          sudo chmod +x /usr/local/bin/shfmt

      - name: Lint
        run: make lint

      - name: Smoke
        if: steps.install-linux.outcome == 'success'
        run: make smoke

      - name: Run tests
        env:
          PDF_DEFLYT_TEST_JOBS: "4"
        run: make test

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-linux
          path: tests/build/logs
